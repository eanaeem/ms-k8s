#
# User-defined substitutions:
#   _CLOUDSDK_COMPUTE_ZONE
#   _CLOUDSDK_CONTAINER_CLUSTER

steps:
  # Generate a kubeconfig file for the given GKE cluster.
  - name: "gcr.io/cloud-builders/kubectl"
    env:
      - "CLOUDSDK_COMPUTE_ZONE=${_CLOUDSDK_COMPUTE_ZONE}"
      - "CLOUDSDK_CONTAINER_CLUSTER=${_CLOUDSDK_CONTAINER_CLUSTER}"
      - "KUBECONFIG=/kube/config"
    entrypoint: "sh"
    args:
      [
        gcloud container clusters get-credentials staging --zone=europe-west1-b --project=cloud-build-229715,
      ]
    volumes:
      - name: "kube"
        path: /kube

  # Apply the Kubernetes configuration files.
  - name: "gcr.io/cloud-builders/gcloud"
    env:
      - "KUBECONFIG=/kube/config"
    entrypoint: "sh"
    args:
      - "-c"
      - |
        kubectl apply --recursive -f kubernetes
    volumes:
      - name: "kube"
        path: /kube
